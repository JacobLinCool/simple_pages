<!DOCTYPE html>
<html>
<head>
    <title>Batch Downloader</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="index.css" rel="stylesheet">
</head>
<body>


    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gildas-lormeau/zip.js@master/WebContent/zip.min.js"></script>
    <script>
    zip.workerScriptsPath = "./zip/";
    var _Zipped;

    async function makeZip(urls) {
        let total = urls.length, finished = 0;
        let promises = [], blobs = [], filenames = [];
        console.log("[Downloader] Start Fetching Files. ");
        for(let i = 0; i < total; i++) {
            filenames.push(urls[i].substring(urls[i].lastIndexOf("/")+1));
            console.log("[Downloader] Fetching File. ", {id: i, name: filenames[i]});
            promises.push(
                fetch(urls[i]).then(response => {
                    if(response.ok) return response.blob();
                    throw new Error("Server Did Not Return 2XX Status Code.");
                }).then(blob => {
                    console.log("[Downloader] Fetched File. ", {id: i, name: filenames[i], data: blob});
                    return blob;
                }).catch(error => {
                    console.error("[Downloader] Fetch Error. ", error.message);
                })
            );
        }
        blobs = await Promise.all(promises);

        zip.createWriter(new zip.BlobWriter("application/zip"), function(writer) {
            for(let i = 0; i < total; i++) {
                writer.add(filenames[i], new zip.BlobReader(blobs[i]), function() {
                    console.log("[File Writer] File Written. ", {id: i, name: filenames[i], data: blobs[i]});
                });
            }
            writer.close(Zipped => {
                console.log("[File Zipper] Files Zipped.  ", Zipped);
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                _Zipped = Zipped;
                url = window.URL.createObjectURL(Zipped);
                a.href = url;
                a.download = "files.zip";
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }, console.error);
    }
</script>
</body>
</html>
